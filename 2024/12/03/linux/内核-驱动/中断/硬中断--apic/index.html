<!DOCTYPE html>
<html lang="en">

<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8">
	<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">

	<!-- title -->
	
	<title>
	
		硬中断--apic |
	
	Sisyphus
	</title>

	<!-- keywords,description -->
	
	

	<!-- favicon -->
	
	<link rel="shortcut icon" href="/favicon.png">
	


	<!-- search -->
	<script>
		var searchEngine = "";
		if(typeof searchEngine == "undefined" || searchEngine == null || searchEngine == ""){
			searchEngine = "https://www.google.com/search?q=";
		}
		var homeHost = "";
		if(typeof homeHost == "undefined" || homeHost == null || homeHost == ""){
			homeHost = window.location.host;
		}
	</script>


	
<link rel="stylesheet" href="/css/main.css">

	
<link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css">

	
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.17.1/build/styles/darcula.min.css">

	
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css">

	
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.27.0/themes/prism.min.css">

	
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.27.0/plugins/line-numbers/prism-line-numbers.min.css">



	
<script src="https://cdn.jsdelivr.net/npm/jquery@3.7.0/dist/jquery.min.js"></script>

	
<script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>

	
<script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.17.1/build/highlight.min.js"></script>

	
<script src="https://cdn.jsdelivr.net/npm/jquery-pjax@2.0.1/jquery.pjax.min.js"></script>

	
<script src="/js/main.js"></script>


	<!-- Mermaid JS -->
	<script src="https://cdn.jsdelivr.net/npm/mermaid@10.9/dist/mermaid.min.js"></script>
	<!-- D3.js -->
	<script src="https://d3js.org/d3.v6.min.js"></script>

	<script>
		// Define the function globally
		(function(d3) {
		function initializeZoom(d3) {
				// Apply the zoom behavior to each SVG
				document.querySelectorAll("pre.mermaid svg").forEach(svg => {
				const zoomBehavior = d3.zoom().on("zoom", (event) => {
					d3.select(svg).select('g').attr("transform", event.transform);
				});
				d3.select(svg).call(zoomBehavior).on("dblclick.zoom", null);
				});
			console.log('Zoom initialized.');
		}

		document.addEventListener('DOMContentLoaded', function() {
			mermaid.initialize({ startOnLoad: true, theme: 'forest' });

			// Polling for SVG rendering
			const checkRender = setInterval(() => {
				if (document.querySelector("pre.mermaid svg")) {
					clearInterval(checkRender);
					// Pass the d3 object to initializeZoom
					initializeZoom(d3);
				}
			}, 300); // Check every 300 milliseconds
		});
		})(window.d3);
	</script>


	
	

<meta name="generator" content="Hexo 7.3.0"></head>


<body>
	<header id="header">
    <a id="title" href="/" class="logo">Sisyphus</a>

	<ul id="menu">
    

    
      <li class="menu-item">
        <a href="/tags" class="menu-item-link">标签</a>
      </li>
    

    
      <li class="menu-item">
        <a href="/categories" class="menu-item-link">分类</a>
      </li>
    

    
  
    
      <li class="menu-item">
        <a href='https://github.com/sisyphus1212' class="menu-item-link" target="_blank">
          <i class="fa fa-github fa-2x"></i>
        </a>
      </li>
    
	</ul>
</header>

	
<div id="sidebar">
	<button id="sidebar-toggle" class="toggle" ><i class="fa fa-arrow-right " aria-hidden="true"></i></button>
	
	<div id="site-toc">
		<input id="search-input" class="search-input" type="search" placeholder="按回车全站搜索">
		<div id="tree">
			

			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										DOCA
									</a>
									
							<ul>
								<li class="file">
									<a href="/2024/12/03/DOCA/virtio-net-controller/">
                     
										    virtio-net-controller
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/12/03/DOCA/%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C/">
                     
										    基本操作
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										dpdk
									</a>
									
							<ul>
								<li class="file">
									<a href="/2023/12/21/dpdk/dpdk%20vhost_user%E5%8D%8F%E8%AE%AE/">
                     
										    vhost_user协议
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/12/03/dpdk/dpdk_iova/">
                     
										    dpdk_iova
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/12/03/dpdk/dpdk_legacy_memory/">
                     
										    dpdk_legacy_memory
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2022/03/19/dpdk/dpdk_mbuf_%E7%BB%93%E6%9E%84/">
                     
										    dpdk mbuf 结构
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/12/03/dpdk/dpdk_memzone_mpool_mbuf%E5%85%B3%E7%B3%BB%E6%A2%B3%E7%90%86/">
                     
										    dpdk_memzone_mpool_mbuf关系梳理
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2022/03/19/dpdk/dpdk_vdpa%E7%83%AD%E8%BF%81%E7%A7%BB-%E8%84%8F%E9%A1%B5%E6%A0%87%E8%AE%B0/">
                     
										    dpdk_vdpa热迁移-脏页标记
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/12/21/dpdk/dpdk%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/">
                     
										    dpdk 内存管理
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/12/21/dpdk/dpdk%E6%B5%8B%E8%AF%95%E7%94%A8%E4%BE%8B/">
                     
										    dpdk测试用例
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/03/19/dpdk/dpdk%E7%BC%96%E8%AF%91/">
                     
										    dpdk 编译
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/03/19/dpdk/dpdk%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87%E5%88%9D%E5%A7%8B%E5%8C%96%E9%80%BB%E8%BE%91/">
                     
										    dpdk 编译
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/03/19/dpdk/testpmd%E4%BD%BF%E7%94%A8/">
                     
										    testpmd使用
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/12/21/dpdk/vhost_user_virtio_net%E5%90%8E%E7%AB%AF%E9%80%BB%E8%BE%91/">
                     
										    dpdk 编译
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										github
									</a>
									
							<ul>
								<li class="file">
									<a href="/2020/11/01/github/git%20%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/">
                     
										    git 常用命令
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										linux
									</a>
									
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										内核-驱动
									</a>
									
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										common
									</a>
									
							<ul>
								<li class="file">
									<a href="/2024/11/20/linux/%E5%86%85%E6%A0%B8-%E9%A9%B1%E5%8A%A8/common/%E5%86%85%E6%A0%B8%E6%89%93%E5%8D%B0%E6%A0%BC%E5%BC%8F/">
                     
										    内核打印格式化
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2022/09/11/linux/%E5%86%85%E6%A0%B8-%E9%A9%B1%E5%8A%A8/common/%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E6%8A%80%E5%B7%A7/">
                     
										    驱动开发技巧
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										cpu
									</a>
									
							<ul>
								<li class="file">
									<a href="/2024/12/03/linux/%E5%86%85%E6%A0%B8-%E9%A9%B1%E5%8A%A8/cpu/cpu%E4%B8%8A%E4%B8%8B%E7%BA%BF/">
                     
										    cpu上下线
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										dma
									</a>
									
							<ul>
								<li class="file">
									<a href="/2024/12/03/linux/%E5%86%85%E6%A0%B8-%E9%A9%B1%E5%8A%A8/dma/gfp/">
                     
										    gfp
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/12/03/linux/%E5%86%85%E6%A0%B8-%E9%A9%B1%E5%8A%A8/dma/iommu%E6%B5%81%E7%A8%8B/">
                     
										    iommu流程
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/12/03/linux/%E5%86%85%E6%A0%B8-%E9%A9%B1%E5%8A%A8/dma/scatterlist/">
                     
										    scatterlist
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										iommu
									</a>
									
							<ul>
								<li class="file">
									<a href="/2024/12/03/linux/%E5%86%85%E6%A0%B8-%E9%A9%B1%E5%8A%A8/iommu/intel_iommu%E5%AF%84%E5%AD%98%E5%99%A8%E8%A7%84%E8%8C%83/">
                     
										    intel_iommu寄存器规范
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/12/03/linux/%E5%86%85%E6%A0%B8-%E9%A9%B1%E5%8A%A8/iommu/iommu/">
                     
										    iommu
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/12/03/linux/%E5%86%85%E6%A0%B8-%E9%A9%B1%E5%8A%A8/iommu/ioremap/">
                     
										    ioremap
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										napi
									</a>
									
							<ul>
								<li class="file">
									<a href="/2024/12/03/linux/%E5%86%85%E6%A0%B8-%E9%A9%B1%E5%8A%A8/napi/napi/">
                     
										    napi
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/12/03/linux/%E5%86%85%E6%A0%B8-%E9%A9%B1%E5%8A%A8/pcie/">
                     
										    pcie
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/12/03/linux/%E5%86%85%E6%A0%B8-%E9%A9%B1%E5%8A%A8/pcie_hotplug/">
                     
										    pcie_hotplug
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/12/03/linux/%E5%86%85%E6%A0%B8-%E9%A9%B1%E5%8A%A8/per_cpu/">
                     
										    per_cpu
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										udev
									</a>
									
							<ul>
								<li class="file">
									<a href="/2022/09/20/linux/%E5%86%85%E6%A0%B8-%E9%A9%B1%E5%8A%A8/udev/linux_udev%E6%9C%BA%E5%88%B6%E5%AE%9E%E7%8E%B0-0/">
                     
										    linux_udev机制实现-0
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2022/09/20/linux/%E5%86%85%E6%A0%B8-%E9%A9%B1%E5%8A%A8/udev/linux_udev%E6%9C%BA%E5%88%B6%E5%AE%9E%E7%8E%B0-1/">
                     
										    linux_udev机制实现-1
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2022/09/20/linux/%E5%86%85%E6%A0%B8-%E9%A9%B1%E5%8A%A8/udev/linux_udev%E6%9C%BA%E5%88%B6%E5%AE%9E%E7%8E%B0-2/">
                     
										    linux_udev机制实现-2
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2022/09/20/linux/%E5%86%85%E6%A0%B8-%E9%A9%B1%E5%8A%A8/udev/linux_udev%E6%9C%BA%E5%88%B6%E5%AE%9E%E7%8E%B0-3/">
                     
										    linux_udev机制实现-3
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2022/09/20/linux/%E5%86%85%E6%A0%B8-%E9%A9%B1%E5%8A%A8/udev/udev_rules%E7%AE%80%E4%BB%8B/">
                     
										    udev机制实现
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2022/09/20/linux/%E5%86%85%E6%A0%B8-%E9%A9%B1%E5%8A%A8/udev/uevent%E6%8E%A5%E5%8F%A3%E5%AE%9E%E7%8E%B0/">
                     
										    uevent接口实现
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										virtio
									</a>
									
							<ul>
								<li class="file">
									<a href="/2024/12/03/linux/%E5%86%85%E6%A0%B8-%E9%A9%B1%E5%8A%A8/virtio/virtio_net/">
                     
										    virtio_net
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										中断
									</a>
									
							<ul>
								<li class="file">
									<a href="/2024/12/03/linux/%E5%86%85%E6%A0%B8-%E9%A9%B1%E5%8A%A8/%E4%B8%AD%E6%96%AD/armv8%E4%B8%AD%E6%96%AD%E7%8E%B0%E5%9C%BA%E4%BF%9D%E5%AD%98%E5%AF%84%E5%AD%98%E5%99%A8/">
                     
										    armv8中断现场保存寄存器
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/12/03/linux/%E5%86%85%E6%A0%B8-%E9%A9%B1%E5%8A%A8/%E4%B8%AD%E6%96%AD/armv8%E8%AE%BE%E5%A4%87%E6%A0%91%E8%A7%A3%E6%9E%90/">
                     
										    armv8设备树解析
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/12/03/linux/%E5%86%85%E6%A0%B8-%E9%A9%B1%E5%8A%A8/%E4%B8%AD%E6%96%AD/msi_domain_alloc/">
                     
										    msi_domain_alloc
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/09/11/linux/%E5%86%85%E6%A0%B8-%E9%A9%B1%E5%8A%A8/%E4%B8%AD%E6%96%AD/%E5%86%85%E6%A0%B8preempt/">
                     
										    内核preempt
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/11/20/linux/%E5%86%85%E6%A0%B8-%E9%A9%B1%E5%8A%A8/%E4%B8%AD%E6%96%AD/%E6%89%93%E5%8D%B0%E5%86%85%E6%A0%B8%E5%87%BD%E6%95%B0%E5%A4%84%E4%BA%8E%E4%BB%80%E4%B9%88%E4%B8%8A%E4%B8%8B%E6%96%87/">
                     
										    打印内核函数处于什么上下文
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/12/03/linux/%E5%86%85%E6%A0%B8-%E9%A9%B1%E5%8A%A8/%E4%B8%AD%E6%96%AD/%E7%A1%AC%E4%B8%AD%E6%96%AD--allocated_irqs%E4%B8%8Eirq_desc%E6%95%B0%E7%BB%84%E5%A6%82%E4%BD%95%E5%8D%8F%E5%90%8C%E5%B7%A5%E4%BD%9C/">
                     
										    硬中断--allocated_irqs与irq_desc数组如何协同工作
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file active">
									<a href="/2024/12/03/linux/%E5%86%85%E6%A0%B8-%E9%A9%B1%E5%8A%A8/%E4%B8%AD%E6%96%AD/%E7%A1%AC%E4%B8%AD%E6%96%AD--apic/">
                     
										    硬中断--apic
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/12/03/linux/%E5%86%85%E6%A0%B8-%E9%A9%B1%E5%8A%A8/%E4%B8%AD%E6%96%AD/%E7%A1%AC%E4%B8%AD%E6%96%AD--asm_do_IRQ/">
                     
										    硬中断--asm_do_IRQ
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/12/03/linux/%E5%86%85%E6%A0%B8-%E9%A9%B1%E5%8A%A8/%E4%B8%AD%E6%96%AD/%E7%A1%AC%E4%B8%AD%E6%96%AD--ioapic/">
                     
										    硬中断--ioapic
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/12/03/linux/%E5%86%85%E6%A0%B8-%E9%A9%B1%E5%8A%A8/%E4%B8%AD%E6%96%AD/%E7%A1%AC%E4%B8%AD%E6%96%AD--irq_domain%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96/">
                     
										    硬中断--irq_domain的初始化
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/12/03/linux/%E5%86%85%E6%A0%B8-%E9%A9%B1%E5%8A%A8/%E4%B8%AD%E6%96%AD/%E7%A1%AC%E4%B8%AD%E6%96%AD--irq_exit/">
                     
										    硬中断--irq_exit
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/12/03/linux/%E5%86%85%E6%A0%B8-%E9%A9%B1%E5%8A%A8/%E4%B8%AD%E6%96%AD/%E7%A1%AC%E4%B8%AD%E6%96%AD--irq_matrix%E7%BB%93%E6%9E%84%E4%BD%93/">
                     
										    硬中断--irq_matrix结构体
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/12/03/linux/%E5%86%85%E6%A0%B8-%E9%A9%B1%E5%8A%A8/%E4%B8%AD%E6%96%AD/%E7%A1%AC%E4%B8%AD%E6%96%AD--x86%E4%B8%AD%E6%96%AD%E5%88%9D%E5%A7%8B%E5%8C%96/">
                     
										    硬中断--x86中断初始化
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/12/03/linux/%E5%86%85%E6%A0%B8-%E9%A9%B1%E5%8A%A8/%E4%B8%AD%E6%96%AD/%E7%A1%AC%E4%B8%AD%E6%96%AD--%E4%B8%AD%E6%96%AD%E5%8F%B7%E6%98%A0%E5%B0%84/">
                     
										    硬中断--中断号映射
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/12/03/linux/%E5%86%85%E6%A0%B8-%E9%A9%B1%E5%8A%A8/%E4%B8%AD%E6%96%AD/%E7%A1%AC%E4%B8%AD%E6%96%AD--%E5%88%9D%E5%A7%8B%E5%8C%96/">
                     
										    硬中断--初始化
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/12/03/linux/%E5%86%85%E6%A0%B8-%E9%A9%B1%E5%8A%A8/%E4%B8%AD%E6%96%AD/%E7%A1%AC%E4%B8%AD%E6%96%AD--%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">
                     
										    硬中断--数据结构
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/12/03/linux/%E5%86%85%E6%A0%B8-%E9%A9%B1%E5%8A%A8/%E4%B8%AD%E6%96%AD/%E7%A1%AC%E4%B8%AD%E6%96%AD--%E7%A1%AC%E4%B8%AD%E6%96%AD%E5%8F%B7%E7%9A%84%E8%A7%A3%E6%9E%90/">
                     
										    硬中断--硬中断号的解析
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/11/20/linux/%E5%86%85%E6%A0%B8-%E9%A9%B1%E5%8A%A8/%E4%B8%AD%E6%96%AD/%E8%BD%AF%E4%B8%AD%E6%96%AD--__do_softirq/">
                     
										    __do_softirq 分析
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/11/20/linux/%E5%86%85%E6%A0%B8-%E9%A9%B1%E5%8A%A8/%E4%B8%AD%E6%96%AD/%E8%BD%AF%E4%B8%AD%E6%96%AD--__raise_softirq/">
                     
										    __raise_softirq 分析
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/11/20/linux/%E5%86%85%E6%A0%B8-%E9%A9%B1%E5%8A%A8/%E4%B8%AD%E6%96%AD/%E8%BD%AF%E4%B8%AD%E6%96%AD--ksoftirqd/">
                     
										    ksoftirqd 分析
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/11/20/linux/%E5%86%85%E6%A0%B8-%E9%A9%B1%E5%8A%A8/%E4%B8%AD%E6%96%AD/%E8%BD%AF%E4%B8%AD%E6%96%AD--net_rx_action/">
                     
										    net_rx_action 分析
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/12/03/linux/%E5%86%85%E6%A0%B8-%E9%A9%B1%E5%8A%A8/%E4%B8%AD%E6%96%AD/%E8%BD%AF%E4%B8%AD%E6%96%AD--wakeup_softirqd/">
                     
										    软中断--wakeup_softirqd
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/11/20/linux/%E5%86%85%E6%A0%B8-%E9%A9%B1%E5%8A%A8/%E4%B8%AD%E6%96%AD/%E8%BD%AF%E4%B8%AD%E6%96%AD--%E4%B8%8A%E4%B8%8B%E6%96%87%E5%88%87%E6%8D%A2%E6%8E%A5%E5%8F%A3/">
                     
										    软中断上下文切换接口
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/09/11/linux/%E5%86%85%E6%A0%B8-%E9%A9%B1%E5%8A%A8/%E4%B8%AD%E6%96%AD/%E8%BD%AF%E4%B8%AD%E6%96%AD--%E4%BD%BF%E7%94%A8%E5%8E%9F%E5%88%99/">
                     
										    软中断使用原则
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2022/09/11/linux/%E5%86%85%E6%A0%B8-%E9%A9%B1%E5%8A%A8/%E4%BF%AE%E6%94%B9%E4%BB%BB%E6%84%8FLinux%E8%BF%9B%E7%A8%8B%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4%E5%AE%9E%E6%96%BD%E4%BB%A3%E7%A0%81%E6%B3%A8%E5%85%A5/">
                     
										    修改任意Linux进程地址空间实施代码注入
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										设备驱动
									</a>
									
							<ul>
								<li class="file">
									<a href="/2022/09/02/linux/%E5%86%85%E6%A0%B8-%E9%A9%B1%E5%8A%A8/%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8/linux%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8resource/">
                     
										    linux设备驱动resource
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										系统启动
									</a>
									
							<ul>
								<li class="file">
									<a href="/2024/11/20/linux/%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8/%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E7%9B%B8%E5%85%B3/">
                     
										    系统启动相关
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										系统基础
									</a>
									
							<ul>
								<li class="file">
									<a href="/2023/08/29/linux/%E7%B3%BB%E7%BB%9F%E5%9F%BA%E7%A1%80/Linux%E4%B8%8B%E7%9A%84%E6%97%B6%E9%92%9F/">
                     
										    Linux下的时钟
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2022/09/20/linux/%E7%B3%BB%E7%BB%9F%E5%9F%BA%E7%A1%80/ptp%E6%97%B6%E9%92%9F%E5%90%8C%E6%AD%A5%E4%BB%8B%E7%BB%8D/">
                     
										    ptp时钟同步介绍
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/03/08/linux/%E7%B3%BB%E7%BB%9F%E5%9F%BA%E7%A1%80/ubuntu%E5%86%85%E6%A0%B8%E6%9E%84%E5%BB%BA/">
                     
										    ubuntu内核构建
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/03/08/linux/%E7%B3%BB%E7%BB%9F%E5%9F%BA%E7%A1%80/ubuntu%E5%8F%91%E8%A1%8C%E7%89%88%E6%9C%AC/">
                     
										    ubuntu发行版本
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										网络协议
									</a>
									
							<ul>
								<li class="file">
									<a href="/2024/03/14/linux/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/perf%E6%8A%93%E5%8F%96%E6%94%B6%E5%8F%91%E5%8C%85%E6%B5%81%E7%A8%8B/">
                     
										    收发包流程
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/12/03/linux/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/tcp%E7%AA%97%E5%8F%A3%E6%9C%BA%E5%88%B6/">
                     
										    tcp窗口机制
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/12/03/linux/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/%E5%8D%8F%E8%AE%AE%E6%A0%88%E6%B5%81%E7%A8%8B/">
                     
										    协议栈流程
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2018/12/17/linux/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/%E5%8D%8F%E8%AE%AE%E6%A0%88%E8%B0%83%E4%BC%98%E5%8C%96tx/">
                     
										    [译] Linux 网络栈监控和调优：发送数据（2017）
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										network
									</a>
									
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										base_knowledge
									</a>
									
							<ul>
								<li class="file">
									<a href="/2022/09/20/network/base_knowledge/tun%20%E4%B8%8E%20tap%20%E8%AE%BE%E5%A4%87%EF%BC%8C%E7%BD%91%E6%A1%A5%E3%80%81VLAN%E3%80%81bonding%20%E7%9A%84%E5%AD%A6%E4%B9%A0/">
                     
										    linux内核网络设备
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2019/07/20/network/base_knowledge/%E7%BD%91%E5%8D%A1%20promiscuous%20mode%20%E4%B8%8E%20MAC%20%E7%9A%84%E4%B8%80%E4%BA%9B%20filter%20%E5%8A%9F%E8%83%BD/">
                     
										    linux内核网络设备
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										debug
									</a>
									
							<ul>
								<li class="file">
									<a href="/2020/11/01/network/debug/dropwatch_%E7%9B%91%E6%8E%A7%E5%86%85%E6%A0%B8%E7%9A%84%E7%BD%91%E7%BB%9C%E6%A0%88%E4%B8%A2%E5%8C%85/">
                     
										    dropwatch 监控内核的网络栈丢包
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										ethtool
									</a>
									
							<ul>
								<li class="file">
									<a href="/2023/11/03/network/ethtool/ethtool_dump_%E7%BD%91%E5%8D%A1%E5%AF%84%E5%AD%98%E5%99%A8/">
                     
										    ethtool 代码架构
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2022/11/04/network/ethtool/ethtool_%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/">
                     
										    ethtool_的工作原理
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										kernel网络
									</a>
									
							<ul>
								<li class="file">
									<a href="/2022/09/07/network/kernel%E7%BD%91%E7%BB%9C/Linux%E7%BD%91%E5%8D%A1%E9%87%8D%E5%91%BD%E5%90%8D/">
                     
										    Linux 网卡重命名
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2019/09/07/network/kernel%E7%BD%91%E7%BB%9C/iproute2%E4%BD%BF%E7%94%A8--nat%E7%BD%91%E6%A1%A5%E9%85%8D%E7%BD%AE/">
                     
										    iproute2使用--nat网桥配置
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/11/18/network/kernel%E7%BD%91%E7%BB%9C/rss_rps_rfs/">
                     
										    Linux 网卡rss,rps,rfs
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2022/09/17/network/kernel%E7%BD%91%E7%BB%9C/%E5%86%85%E6%A0%B8%E6%97%A5%E5%BF%97%E6%89%93%E5%8D%B0%E9%99%90%E9%80%9F/">
                     
										    内核日志打印限速
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2022/08/29/network/kernel%E7%BD%91%E7%BB%9C/%E5%8F%8C%E7%BD%91%E5%8D%A1%E7%9A%84bounding%E6%A8%A1%E5%BC%8F/">
                     
										    双网卡的bounding模式
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2022/08/29/network/kernel%E7%BD%91%E7%BB%9C/%E7%BD%91%E7%BB%9C%E4%B8%A2%E5%8C%85%E6%95%85%E9%9A%9C%E5%AE%9A%E4%BD%8D%E5%85%A8%E6%99%AF%E6%8C%87%E5%8D%97/">
                     
										    网络丢包故障定位全景指南
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2022/09/17/network/kernel%E7%BD%91%E7%BB%9C/%E9%80%9A%E8%BF%87%E9%A9%B1%E5%8A%A8%E6%9D%A5%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AAeth_device/">
                     
										    通过驱动来创建一个eth device
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2022/09/20/network/p4%E7%A8%8B%E5%BA%8F%E7%9A%84%E8%B5%84%E6%BA%90%E4%BC%98%E5%8C%96%E6%8C%87%E5%8D%97/">
                     
										    p4程序的资源优化指南
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										rte_kni
									</a>
									
							<ul>
								<li class="file">
									<a href="/2022/09/07/network/rte_kni/dpdk%20kni%20%E8%99%9A%E6%8B%9F%E7%BD%91%E7%BB%9C%E6%8E%A5%E5%8F%A3%E5%8E%9F%E7%90%86/">
                     
										    dpdk 程序kni 虚拟网络接口原理
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2022/09/07/network/rte_kni/dpdk%20%E7%A8%8B%E5%BA%8F%E5%AF%B9pause%20%E5%B8%A7%E7%9A%84%E5%A4%84%E7%90%86/">
                     
										    dpdk 程序对pause 帧的处理
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2022/09/07/network/rte_kni/%E9%80%9A%E8%BF%87slabinfo%E5%AE%9A%E4%BD%8D%E5%86%85%E5%AD%98%E6%B3%84%E9%9C%B2%E9%97%AE%E9%A2%98/">
                     
										    dpdk 程序创建 kni 虚拟网络接口失败的问题
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2022/08/29/network/%E5%B8%B8%E7%94%A8%E7%BD%91%E7%BB%9C%E6%95%85%E9%9A%9C%E6%8E%92%E6%9F%A5%E5%B7%A5%E5%85%B7/">
                     
										    常用网络故障排查工具
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										other
									</a>
									
							<ul>
								<li class="file">
									<a href="/2023/11/01/other/c%E8%AF%AD%E8%A8%80%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88/">
                     
										    c语言-智能指针的用法
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/03/18/other/frpc%E6%9E%81%E7%AE%80%E9%83%A8%E7%BD%B2/">
                     
										    frpc极简部署
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2022/08/29/other/githubpage-vscocd-hexo%E6%9E%84%E5%BB%BA%E7%AC%94%E8%AE%B0%E5%8D%9A%E5%AE%A2/">
                     
										    githubpage+vscocd+hexo构建笔记博客
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										graphviz
									</a>
									
							<ul>
								<li class="file">
									<a href="/2023/12/21/other/graphviz/graphviz/">
                     
										    graphviz
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/05/24/other/graphviz/tips/">
                     
										    graphviz—tips
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/03/11/other/vscode_git_auto_push/">
                     
										    vscode-git-自动push
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2022/08/29/other/windows_treminal/">
                     
										    windows terminal技巧
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										pcie
									</a>
									
							<ul>
								<li class="file">
									<a href="/2024/12/03/pcie/dmar--root_table/">
                     
										    dmar--root_table
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/12/03/pcie/pasid/">
                     
										    pasid
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										qemu
									</a>
									
							<ul>
								<li class="file">
									<a href="/2024/12/03/qemu/IPI%E4%B8%AD%E6%96%AD%E6%80%A7%E8%83%BD%E8%AF%84%E4%BC%B0/">
                     
										    IPI中断性能评估
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/12/03/qemu/Kick_vcpu/">
                     
										    Kick_vcpu
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/12/21/qemu/dhcp%E6%9C%8D%E5%8A%A1%E5%BF%AB%E9%80%9F%E9%83%A8%E7%BD%B2/">
                     
										    为qemu运行快速部署dhcp服务
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/12/03/qemu/gust%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/">
                     
										    gust内存管理
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/12/03/qemu/kvm/">
                     
										    kvm
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/12/03/qemu/qemu%20vhost_user%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96%E9%80%BB%E8%BE%91/">
                     
										    qemu vhost_user的初始化逻辑
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/04/20/qemu/qemu-kvm%E5%86%85%E5%AD%98%E8%99%9A%E6%8B%9F%E5%8C%96/">
                     
										    qemu-kvm 内存虚拟化
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/04/20/qemu/qemu%E5%88%9D%E5%A7%8B%E5%8C%96/">
                     
										    qemu 初始化流程
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/12/21/qemu/qemu%E5%90%8E%E7%AB%AF%E5%86%99%E6%B8%85%E9%99%A4%E6%9C%BA%E5%88%B6/">
                     
										    qemu后端写清除机制
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/07/21/qemu/qemu%E8%BF%90%E8%A1%8Cvirtio_net%E7%9A%84%E5%87%A0%E7%A7%8D%E6%A8%A1%E5%BC%8F/">
                     
										    qemu运行virtio_net的几种模式
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/12/03/qemu/qom%E6%A8%A1%E5%9E%8B/">
                     
										    qom模型
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/12/03/qemu/vcpu%E8%BF%81%E7%A7%BB/">
                     
										    vcpu迁移
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/12/03/qemu/vmcs/">
                     
										    vmcs
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/12/03/qemu/%E4%B8%AD%E6%96%AD%E8%99%9A%E6%8B%9F%E5%8C%96/">
                     
										    中断虚拟化
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										性能优化
									</a>
									
							<ul>
								<li class="file">
									<a href="/2024/09/24/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/cpu%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">
                     
										    cpu性能优化
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/12/03/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/perf%E6%80%A7%E8%83%BD%E8%A7%82%E6%B5%8B/">
                     
										    perf性能观测
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/12/03/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E5%8F%AF%E8%A7%82%E6%B5%8B%E5%B7%A5%E5%85%B7/">
                     
										    可观测工具
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										硬件相关
									</a>
									
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										dram
									</a>
									
							<ul>
								<li class="file">
									<a href="/2024/12/03/%E7%A1%AC%E4%BB%B6%E7%9B%B8%E5%85%B3/dram/DRAM%E5%9F%BA%E6%9C%AC%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/">
                     
										    DRAM基本工作原理
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2022/08/29/%E7%A1%AC%E4%BB%B6%E7%9B%B8%E5%85%B3/pcie%20%E5%87%80%E8%BD%BD%E8%8D%B7%E8%BD%AC%E5%8F%91%E5%B8%A6%E5%AE%BD/">
                     
										    pcie 净载荷转发带宽
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										pcie
									</a>
									
							<ul>
								<li class="file">
									<a href="/2024/03/23/%E7%A1%AC%E4%BB%B6%E7%9B%B8%E5%85%B3/pcie/PCIe%20ECAM%E4%BB%8B%E7%BB%8D/">
                     
										    PCIe ECAM介绍
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/12/03/%E7%A1%AC%E4%BB%B6%E7%9B%B8%E5%85%B3/pcie/tlp/">
                     
										    tlp
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/08/29/%E7%A1%AC%E4%BB%B6%E7%9B%B8%E5%85%B3/rmii/">
                     
										    rmii
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/06/29/%E7%A1%AC%E4%BB%B6%E7%9B%B8%E5%85%B3/serders%E5%8E%9F%E7%90%86/">
                     
										    serder
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										虚拟化
									</a>
									
							<ul>
								<li class="file">
									<a href="/2023/09/20/%E8%99%9A%E6%8B%9F%E5%8C%96/pcie_%E8%99%9A%E6%8B%9F%E5%8C%96/">
                     
										    pcie 入门
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2023/09/20/%E8%99%9A%E6%8B%9F%E5%8C%96/vdpa/">
                     
										    vdpa代码逻辑
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/07/23/%E8%99%9A%E6%8B%9F%E5%8C%96/virtio/">
                     
										    virtio 协议
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/12/03/%E8%99%9A%E6%8B%9F%E5%8C%96/virtio_pci/">
                     
										    virtio_pci
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/12/03/%E8%99%9A%E6%8B%9F%E5%8C%96/%E4%B8%AD%E6%96%AD%E8%99%9A%E6%8B%9F%E5%8C%96/">
                     
										    中断虚拟化
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/12/03/%E8%99%9A%E6%8B%9F%E5%8C%96/%E5%86%85%E6%A0%B8%E7%9A%84vdpa%E6%96%B9%E6%A1%88/">
                     
										    内核的vdpa方案
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/03/20/%E8%99%9A%E6%8B%9F%E5%8C%96/%E7%83%AD%E8%BF%81%E7%A7%BB%E4%BB%A3%E7%A0%81%E9%80%BB%E8%BE%91/">
                     
										    热迁移代码逻辑
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										热迁移
									</a>
									
							<ul>
								<li class="file">
									<a href="/2024/03/20/%E8%99%9A%E6%8B%9F%E5%8C%96/%E7%83%AD%E8%BF%81%E7%A7%BB/0-%E6%80%BB%E4%BD%93%E4%BB%8B%E7%BB%8D/">
                     
										    热迁移代码逻辑
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/04/20/%E8%99%9A%E6%8B%9F%E5%8C%96/%E7%83%AD%E8%BF%81%E7%A7%BB/1-%E5%86%85%E5%AD%98%E7%83%AD%E8%BF%81%E7%A7%BB/">
                     
										    内存热迁移
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/04/20/%E8%99%9A%E6%8B%9F%E5%8C%96/%E7%83%AD%E8%BF%81%E7%A7%BB/1.1-%E5%9F%BA%E7%A1%80%E7%94%A8%E6%B3%95/">
                     
										    内存热迁移-基础用法
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/04/20/%E8%99%9A%E6%8B%9F%E5%8C%96/%E7%83%AD%E8%BF%81%E7%A7%BB/1.2-%E8%84%8F%E9%A1%B5%E6%A0%87%E8%AE%B0/">
                     
										    内存热迁移-脏页标记
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/04/20/%E8%99%9A%E6%8B%9F%E5%8C%96/%E7%83%AD%E8%BF%81%E7%A7%BB/2-%E8%AE%BE%E5%A4%87%E7%83%AD%E8%BF%81%E7%A7%BB/">
                     
										    设备热迁移
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2024/04/20/%E8%99%9A%E6%8B%9F%E5%8C%96/%E7%83%AD%E8%BF%81%E7%A7%BB/%E8%AE%BE%E5%A4%87%E7%83%AD%E8%BF%81%E7%A7%BBqemu%E4%B8%8Edpdk%E9%80%9A%E8%BF%87vhost_user%E7%9A%84%E4%BA%A4%E4%BA%92%E6%B5%81%E7%A8%8B/">
                     
										    设备热迁移qemu与dpdk通过vhost_user的交互流程
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										读书笔记
									</a>
									
							<ul>
								<li class="file">
									<a href="/2024/11/18/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/%E5%BA%B7%E5%BE%B7/">
                     
										    纯粹理性批判
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
							<ul>
								<li class="directory">
									<a href="#" class="directory">
										<i class="fa fa-plus-square-o"></i>
										软件开发
									</a>
									
							<ul>
								<li class="file">
									<a href="/2024/07/11/%E8%BD%AF%E4%BB%B6%E5%BC%80%E5%8F%91/gdb/">
                     
										    常用调试方法
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2022/10/01/%E8%BD%AF%E4%BB%B6%E5%BC%80%E5%8F%91/github_action/">
                     
										    github action使用介绍
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
							<ul>
								<li class="file">
									<a href="/2020/11/01/%E8%BD%AF%E4%BB%B6%E5%BC%80%E5%8F%91/git%E5%B8%B8%E7%94%A8/">
                     
										    git 常用命令
                     
									</a>
								</li>
								<div class="article-toc" style="display: none;"></div>
							</ul>
			
								</li>
								
							</ul>
			
		</div>
	</div>
</div>



	<!-- 引入正文 -->
	<div id="content" class="content">
		<h1 id="article-title">
	硬中断--apic
</h1>

<!-- meta -->
<div class="article-meta">
	

	<span>liaocj</span>
	<span>2024-12-03 09:02:56</span>

  <div id="article-categories">
    
		  <span>Categories：</span>
      
    

    
		    <span>Tags：</span>
        
    
  </div>

</div>

<!-- content -->
<div id="article-content">
	<h1 id="硬件规范"><a href="#硬件规范" class="headerlink" title="硬件规范"></a>硬件规范</h1><p>APIC的信息在SDM vol3中有比较详细的介绍<br><img src="https://github.com/sisyphus1212/images_0/blob/main/%E7%A1%AC%E4%B8%AD%E6%96%AD--apic_image.png?raw=true" alt="alt text"><br><img src="https://github.com/sisyphus1212/images_0/blob/main/%E7%A1%AC%E4%B8%AD%E6%96%AD--apic_image-1.png?raw=true" alt="alt text"><br><img src="https://github.com/sisyphus1212/images_0/blob/main/%E7%A1%AC%E4%B8%AD%E6%96%AD--apic_image-3.png?raw=true" alt="alt text"><br>外设的中断过程<br><img src="https://github.com/sisyphus1212/images_0/blob/main/%E7%A1%AC%E4%B8%AD%E6%96%AD--apic_image-2.png?raw=true" alt="alt text"><br><img src="https://github.com/sisyphus1212/images_0/blob/main/%E7%A1%AC%E4%B8%AD%E6%96%AD--apic_image-5.png?raw=true" alt="alt text"></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">linux<span class="token punctuation">.</span>git<span class="token operator">/</span>arch<span class="token operator">/</span>x86<span class="token operator">/</span>kernel<span class="token operator">/</span>apic<span class="token operator">/</span>io_apic<span class="token punctuation">.</span>c
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">__ioapic_write_entry</span><span class="token punctuation">(</span><span class="token keyword">int</span> apic<span class="token punctuation">,</span> <span class="token keyword">int</span> pin<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">IO_APIC_route_entry</span> e<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">union</span> entry_union eu<span class="token punctuation">;</span>
    eu<span class="token punctuation">.</span>entry <span class="token operator">=</span> e<span class="token punctuation">;</span>
    <span class="token comment">/*
     * reg：是寄存器地址（相对比基址的偏移）；0x10，是IO APIC重定向开始的偏移，对于第1个管脚，pin值为0，0x10，0x11恰好是第一个entry；对于第2个管脚，pin值为2，0x12，0x13对应第二个entry。
     * value：要写入的内容，eu.w2是entry的低32位；eu.w1是entry的高32位。
     *
     */</span>
    <span class="token function">io_apic_write</span><span class="token punctuation">(</span>apic<span class="token punctuation">,</span> <span class="token number">0x11</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token operator">*</span>pin<span class="token punctuation">,</span> eu<span class="token punctuation">.</span>w2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">io_apic_write</span><span class="token punctuation">(</span>apic<span class="token punctuation">,</span> <span class="token number">0x10</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token operator">*</span>pin<span class="token punctuation">,</span> eu<span class="token punctuation">.</span>w1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">io_apic_write</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> apic<span class="token punctuation">,</span>
<span class="token keyword">unsigned</span> <span class="token keyword">int</span> reg<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> value<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">struct</span> <span class="token class-name">io_apic</span> __iomem <span class="token operator">*</span>io_apic <span class="token operator">=</span> <span class="token function">io_apic_base</span><span class="token punctuation">(</span>apic<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">writel</span><span class="token punctuation">(</span>reg<span class="token punctuation">,</span> <span class="token operator">&amp;</span>io_apic<span class="token operator">-></span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">writel</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token operator">&amp;</span>io_apic<span class="token operator">-></span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-c" data-language="c"><code class="language-c">Timer related<span class="token operator">:</span>

    CCR<span class="token operator">:</span> Current Count Register
    ICR<span class="token operator">:</span> Initial Count Register
    DCR<span class="token operator">:</span> Divide Configuration Register
    Timer<span class="token operator">:</span> in LVT

<span class="token function">LVT</span> <span class="token punctuation">(</span>Local Vector Table<span class="token punctuation">)</span><span class="token operator">:</span>

    Timer
    Local Interrupt
    Performance Monitor Counters
    Thermal Sensor
    Error

IPI<span class="token operator">:</span>

    ICR<span class="token operator">:</span> Interrupt Command Register
    LDR<span class="token operator">:</span> Logical Destination Register
    DFR<span class="token operator">:</span> Destination Format Register

Interrupt State<span class="token operator">:</span>

    ISR<span class="token operator">:</span> In<span class="token operator">-</span>Service Register
    IRR<span class="token operator">:</span> Interrupt Request Register
    TMR<span class="token operator">:</span> Trigger Mode Register<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h1><pre class="line-numbers language-c" data-language="c"><code class="language-c">    <span class="token comment">/**
 * setup_local_APIC - setup the local APIC
 *
 * Used to setup local APIC while initializing BSP or bringing up APs.
 * Always called with preemption disabled.
 */</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setup_local_APIC</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> cpu <span class="token operator">=</span> <span class="token function">smp_processor_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> value<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>disable_apic<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">disable_ioapic_support</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/*
     * If this comes from kexec/kcrash the APIC might be enabled in
     * SPIV. Soft disable it before doing further initialization.
     */</span>
    value <span class="token operator">=</span> <span class="token function">apic_read</span><span class="token punctuation">(</span>APIC_SPIV<span class="token punctuation">)</span><span class="token punctuation">;</span>
    value <span class="token operator">&amp;=</span> <span class="token operator">~</span>APIC_SPIV_APIC_ENABLED<span class="token punctuation">;</span>
    <span class="token function">apic_write</span><span class="token punctuation">(</span>APIC_SPIV<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_X86_32</span></span>
    <span class="token comment">/* Pound the ESR really hard over the head with a big hammer - mbligh */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">lapic_is_integrated</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> apic<span class="token operator">-></span>disable_esr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">apic_write</span><span class="token punctuation">(</span>APIC_ESR<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">apic_write</span><span class="token punctuation">(</span>APIC_ESR<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">apic_write</span><span class="token punctuation">(</span>APIC_ESR<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">apic_write</span><span class="token punctuation">(</span>APIC_ESR<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    <span class="token comment">/*
     * Double-check whether this APIC is really registered.
     * This is meaningless in clustered apic mode, so we skip it.
     */</span>
    <span class="token function">BUG_ON</span><span class="token punctuation">(</span><span class="token operator">!</span>apic<span class="token operator">-></span><span class="token function">apic_id_registered</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/*
     * Intel recommends to set DFR, LDR and TPR before enabling
     * an APIC.  See e.g. "AP-388 82489DX User's Manual" (Intel
     * document number 292116).  So here it goes...
     */</span>
    apic<span class="token operator">-></span><span class="token function">init_apic_ldr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_X86_32</span></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>apic<span class="token operator">-></span>dest_mode_logical<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> logical_apicid<span class="token punctuation">,</span> ldr_apicid<span class="token punctuation">;</span>

        <span class="token comment">/*
         * APIC LDR is initialized.  If logical_apicid mapping was
         * initialized during get_smp_config(), make sure it matches
         * the actual value.
         */</span>
        logical_apicid <span class="token operator">=</span> <span class="token function">early_per_cpu</span><span class="token punctuation">(</span>x86_cpu_to_logical_apicid<span class="token punctuation">,</span> cpu<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ldr_apicid <span class="token operator">=</span> <span class="token function">GET_APIC_LOGICAL_ID</span><span class="token punctuation">(</span><span class="token function">apic_read</span><span class="token punctuation">(</span>APIC_LDR<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>logical_apicid <span class="token operator">!=</span> BAD_APICID<span class="token punctuation">)</span>
            <span class="token function">WARN_ON</span><span class="token punctuation">(</span>logical_apicid <span class="token operator">!=</span> ldr_apicid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/* Always use the value from LDR. */</span>
        <span class="token function">early_per_cpu</span><span class="token punctuation">(</span>x86_cpu_to_logical_apicid<span class="token punctuation">,</span> cpu<span class="token punctuation">)</span> <span class="token operator">=</span> ldr_apicid<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

    <span class="token comment">/*
     * Set Task Priority to 'accept all except vectors 0-31'.  An APIC
     * vector in the 16-31 range could be delivered if TPR == 0, but we
     * would think it's an exception and terrible things will happen.  We
     * never change this later on.
     */</span>
    value <span class="token operator">=</span> <span class="token function">apic_read</span><span class="token punctuation">(</span>APIC_TASKPRI<span class="token punctuation">)</span><span class="token punctuation">;</span>
    value <span class="token operator">&amp;=</span> <span class="token operator">~</span>APIC_TPRI_MASK<span class="token punctuation">;</span>
    value <span class="token operator">|=</span> <span class="token number">0x10</span><span class="token punctuation">;</span>
    <span class="token function">apic_write</span><span class="token punctuation">(</span>APIC_TASKPRI<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* Clear eventually stale ISR/IRR bits */</span>
    <span class="token function">apic_pending_intr_clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/*
     * Now that we are all set up, enable the APIC
     */</span>
    value <span class="token operator">=</span> <span class="token function">apic_read</span><span class="token punctuation">(</span>APIC_SPIV<span class="token punctuation">)</span><span class="token punctuation">;</span>
    value <span class="token operator">&amp;=</span> <span class="token operator">~</span>APIC_VECTOR_MASK<span class="token punctuation">;</span>
    <span class="token comment">/*
     * Enable APIC
     */</span>
    value <span class="token operator">|=</span> APIC_SPIV_APIC_ENABLED<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_X86_32</span></span>
    <span class="token comment">/*
     * Some unknown Intel IO/APIC (or APIC) errata is biting us with
     * certain networking cards. If high frequency interrupts are
     * happening on a particular IOAPIC pin, plus the IOAPIC routing
     * entry is masked/unmasked at a high rate as well then sooner or
     * later IOAPIC line gets 'stuck', no more interrupts are received
     * from the device. If focus CPU is disabled then the hang goes
     * away, oh well :-(
     *
     * [ This bug can be reproduced easily with a level-triggered
     *   PCI Ne2000 networking cards and PII/PIII processors, dual
     *   BX chipset. ]
     */</span>
    <span class="token comment">/*
     * Actually disabling the focus CPU check just makes the hang less
     * frequent as it makes the interrupt distribution model be more
     * like LRU than MRU (the short-term load is more even across CPUs).
     */</span>

    <span class="token comment">/*
     * - enable focus processor (bit==0)
     * - 64bit mode always use processor focus
     *   so no need to set it
     */</span>
    value <span class="token operator">&amp;=</span> <span class="token operator">~</span>APIC_SPIV_FOCUS_DISABLED<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

    <span class="token comment">/*
     * Set spurious IRQ vector
     */</span>
    value <span class="token operator">|=</span> SPURIOUS_APIC_VECTOR<span class="token punctuation">;</span>
    <span class="token function">apic_write</span><span class="token punctuation">(</span>APIC_SPIV<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">perf_events_lapic_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/*
     * Set up LVT0, LVT1:
     *
     * set up through-local-APIC on the boot CPU's LINT0. This is not
     * strictly necessary in pure symmetric-IO mode, but sometimes
     * we delegate interrupts to the 8259A.
     */</span>
    <span class="token comment">/*
     * TODO: set up through-local-APIC from through-I/O-APIC? --macro
     */</span>
    value <span class="token operator">=</span> <span class="token function">apic_read</span><span class="token punctuation">(</span>APIC_LVT0<span class="token punctuation">)</span> <span class="token operator">&amp;</span> APIC_LVT_MASKED<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cpu <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>pic_mode <span class="token operator">||</span> <span class="token operator">!</span>value <span class="token operator">||</span> skip_ioapic_setup<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        value <span class="token operator">=</span> APIC_DM_EXTINT<span class="token punctuation">;</span>
        <span class="token function">apic_printk</span><span class="token punctuation">(</span>APIC_VERBOSE<span class="token punctuation">,</span> <span class="token string">"enabled ExtINT on CPU#%d\n"</span><span class="token punctuation">,</span> cpu<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        value <span class="token operator">=</span> APIC_DM_EXTINT <span class="token operator">|</span> APIC_LVT_MASKED<span class="token punctuation">;</span>
        <span class="token function">apic_printk</span><span class="token punctuation">(</span>APIC_VERBOSE<span class="token punctuation">,</span> <span class="token string">"masked ExtINT on CPU#%d\n"</span><span class="token punctuation">,</span> cpu<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">apic_write</span><span class="token punctuation">(</span>APIC_LVT0<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/*
     * Only the BSP sees the LINT1 NMI signal by default. This can be
     * modified by apic_extnmi= boot option.
     */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">!</span>cpu <span class="token operator">&amp;&amp;</span> apic_extnmi <span class="token operator">!=</span> APIC_EXTNMI_NONE<span class="token punctuation">)</span> <span class="token operator">||</span>
        apic_extnmi <span class="token operator">==</span> APIC_EXTNMI_ALL<span class="token punctuation">)</span>
        value <span class="token operator">=</span> APIC_DM_NMI<span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        value <span class="token operator">=</span> APIC_DM_NMI <span class="token operator">|</span> APIC_LVT_MASKED<span class="token punctuation">;</span>

    <span class="token comment">/* Is 82489DX ? */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">lapic_is_integrated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        value <span class="token operator">|=</span> APIC_LVT_LEVEL_TRIGGER<span class="token punctuation">;</span>
    <span class="token function">apic_write</span><span class="token punctuation">(</span>APIC_LVT1<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_X86_MCE_INTEL</span></span>
    <span class="token comment">/* Recheck CMCI information after local APIC is up on CPU #0 */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cpu<span class="token punctuation">)</span>
        <span class="token function">cmci_recheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">x86_vector_alloc_irqs</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">irq_domain</span> <span class="token operator">*</span>domain<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> virq<span class="token punctuation">,</span>
                 <span class="token keyword">unsigned</span> <span class="token keyword">int</span> nr_irqs<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">struct</span> <span class="token class-name">irq_alloc_info</span> <span class="token operator">*</span>info <span class="token operator">=</span> arg<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">apic_chip_data</span> <span class="token operator">*</span>apicd<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">irq_data</span> <span class="token operator">*</span>irqd<span class="token punctuation">;</span>
    <span class="token keyword">int</span> i<span class="token punctuation">,</span> err<span class="token punctuation">,</span> node<span class="token punctuation">;</span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"DEBUG***** x86_vector_alloc_irqs0: %px\n"</span><span class="token punctuation">,</span> x86_vector_alloc_irqs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>disable_apic<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>ENXIO<span class="token punctuation">;</span>

    <span class="token comment">/* Currently vector allocator can't guarantee contiguous allocations */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>info<span class="token operator">-></span>flags <span class="token operator">&amp;</span> X86_IRQ_ALLOC_CONTIGUOUS_VECTORS<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> nr_irqs <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>ENOSYS<span class="token punctuation">;</span>

    <span class="token comment">/*
     * Catch any attempt to touch the cascade interrupt on a PIC
     * equipped system.
     */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">WARN_ON_ONCE</span><span class="token punctuation">(</span>info<span class="token operator">-></span>flags <span class="token operator">&amp;</span> X86_IRQ_ALLOC_LEGACY <span class="token operator">&amp;&amp;</span>
             virq <span class="token operator">==</span> PIC_CASCADE_IR<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nr_irqs<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        irqd <span class="token operator">=</span> <span class="token function">irq_domain_get_irq_data</span><span class="token punctuation">(</span>domain<span class="token punctuation">,</span> virq <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">BUG_ON</span><span class="token punctuation">(</span><span class="token operator">!</span>irqd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        node <span class="token operator">=</span> <span class="token function">irq_data_get_node</span><span class="token punctuation">(</span>irqd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">WARN_ON_ONCE</span><span class="token punctuation">(</span>irqd<span class="token operator">-></span>chip_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        apicd <span class="token operator">=</span> <span class="token function">alloc_apic_chip_data</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>apicd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            err <span class="token operator">=</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
            <span class="token keyword">goto</span> error<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        apicd<span class="token operator">-></span>irq <span class="token operator">=</span> virq <span class="token operator">+</span> i<span class="token punctuation">;</span>
        irqd<span class="token operator">-></span>chip <span class="token operator">=</span> <span class="token operator">&amp;</span>lapic_controller<span class="token punctuation">;</span>
        irqd<span class="token operator">-></span>chip_data <span class="token operator">=</span> apicd<span class="token punctuation">;</span>
        irqd<span class="token operator">-></span>hwirq <span class="token operator">=</span> virq <span class="token operator">+</span> i<span class="token punctuation">;</span>
        <span class="token function">irqd_set_single_target</span><span class="token punctuation">(</span>irqd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/*
         * Prevent that any of these interrupts is invoked in
         * non interrupt context via e.g. generic_handle_irq()
         * as that can corrupt the affinity move state.
         */</span>
        <span class="token function">irqd_set_handle_enforce_irqctx</span><span class="token punctuation">(</span>irqd<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/* Don't invoke affinity setter on deactivated interrupts */</span>
        <span class="token function">irqd_set_affinity_on_activate</span><span class="token punctuation">(</span>irqd<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/*
         * Legacy vectors are already assigned when the IOAPIC
         * takes them over. They stay on the same vector. This is
         * required for check_timer() to work correctly as it might
         * switch back to legacy mode. Only update the hardware
         * config.
         */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>info<span class="token operator">-></span>flags <span class="token operator">&amp;</span> X86_IRQ_ALLOC_LEGACY<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">vector_configure_legacy</span><span class="token punctuation">(</span>virq <span class="token operator">+</span> i<span class="token punctuation">,</span> irqd<span class="token punctuation">,</span> apicd<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        err <span class="token operator">=</span> <span class="token function">assign_irq_vector_policy</span><span class="token punctuation">(</span>irqd<span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">trace_vector_setup</span><span class="token punctuation">(</span>virq <span class="token operator">+</span> i<span class="token punctuation">,</span> false<span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            irqd<span class="token operator">-></span>chip_data <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
            <span class="token function">free_apic_chip_data</span><span class="token punctuation">(</span>apicd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> error<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

error<span class="token operator">:</span>
    <span class="token function">x86_vector_free_irqs</span><span class="token punctuation">(</span>domain<span class="token punctuation">,</span> virq<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> err<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">static</span> <span class="token class-name">irq_hw_number_t</span> <span class="token function">msi_domain_ops_get_hwirq</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">msi_domain_info</span> <span class="token operator">*</span>info<span class="token punctuation">,</span>
                        <span class="token class-name">msi_alloc_info_t</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> arg<span class="token operator">-></span>hwirq<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">dmar_msi_init</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">irq_domain</span> <span class="token operator">*</span>domain<span class="token punctuation">,</span>
             <span class="token keyword">struct</span> <span class="token class-name">msi_domain_info</span> <span class="token operator">*</span>info<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> virq<span class="token punctuation">,</span>
             <span class="token class-name">irq_hw_number_t</span> hwirq<span class="token punctuation">,</span> <span class="token class-name">msi_alloc_info_t</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"===========================dmar_msi_init===========================\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">dump_stack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">irq_domain_set_info</span><span class="token punctuation">(</span>domain<span class="token punctuation">,</span> virq<span class="token punctuation">,</span> arg<span class="token operator">-></span>devid<span class="token punctuation">,</span> info<span class="token operator">-></span>chip<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
                handle_edge_irq<span class="token punctuation">,</span> arg<span class="token operator">-></span>data<span class="token punctuation">,</span> <span class="token string">"edge"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">msi_domain_alloc</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">irq_domain</span> <span class="token operator">*</span>domain<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> virq<span class="token punctuation">,</span>
                <span class="token keyword">unsigned</span> <span class="token keyword">int</span> nr_irqs<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">struct</span> <span class="token class-name">msi_domain_info</span> <span class="token operator">*</span>info <span class="token operator">=</span> domain<span class="token operator">-></span>host_data<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">msi_domain_ops</span> <span class="token operator">*</span>ops <span class="token operator">=</span> info<span class="token operator">-></span>ops<span class="token punctuation">;</span>
    <span class="token class-name">irq_hw_number_t</span> hwirq <span class="token operator">=</span> ops<span class="token operator">-></span><span class="token function">get_hwirq</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//msi_domain_ops_get_hwirq</span>
    <span class="token keyword">int</span> i<span class="token punctuation">,</span> ret<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">irq_find_mapping</span><span class="token punctuation">(</span>domain<span class="token punctuation">,</span> hwirq<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EEXIST<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>domain<span class="token operator">-></span>parent<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        ret <span class="token operator">=</span> <span class="token function">irq_domain_alloc_irqs_parent</span><span class="token punctuation">(</span>domain<span class="token punctuation">,</span> virq<span class="token punctuation">,</span> nr_irqs<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nr_irqs<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"msi_domain_alloc:ops->msi_init=%px\n"</span><span class="token punctuation">,</span> ops<span class="token operator">-></span>msi_init<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret <span class="token operator">=</span> ops<span class="token operator">-></span><span class="token function">msi_init</span><span class="token punctuation">(</span>domain<span class="token punctuation">,</span> info<span class="token punctuation">,</span> virq <span class="token operator">+</span> i<span class="token punctuation">,</span> hwirq <span class="token operator">+</span> i<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ops<span class="token operator">-></span>msi_free<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">;</span> i <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span>
                    ops<span class="token operator">-></span><span class="token function">msi_free</span><span class="token punctuation">(</span>domain<span class="token punctuation">,</span> info<span class="token punctuation">,</span> virq <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token function">irq_domain_free_irqs_top</span><span class="token punctuation">(</span>domain<span class="token punctuation">,</span> virq<span class="token punctuation">,</span> nr_irqs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">irq_domain_alloc_irqs_hierarchy</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">irq_domain</span> <span class="token operator">*</span>domain<span class="token punctuation">,</span>
                    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> irq_base<span class="token punctuation">,</span>
                    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> nr_irqs<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>domain<span class="token operator">-></span>ops<span class="token operator">-></span>alloc<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"domain->ops->alloc() is NULL\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>ENOSYS<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// 这里调用了两个地方 static const struct irq_domain_ops x86_vector_domain_ops 和 static const struct irq_domain_ops msi_domain_ops</span>
    <span class="token comment">//irq_domain_alloc_irqs_hierarchy[domain->ops->alloc] domain == domain->parent</span>
    <span class="token keyword">return</span> domain<span class="token operator">-></span>ops<span class="token operator">-></span><span class="token function">alloc</span><span class="token punctuation">(</span>domain<span class="token punctuation">,</span> irq_base<span class="token punctuation">,</span> nr_irqs<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/**
 * __irq_domain_alloc_irqs - Allocate IRQs from domain
 * @domain:	domain to allocate from
 * @irq_base:	allocate specified IRQ number if irq_base >= 0
 * @nr_irqs:	number of IRQs to allocate
 * @node:	NUMA node id for memory allocation
 * @arg:	domain specific argument
 * @realloc:	IRQ descriptors have already been allocated if true
 * @affinity:	Optional irq affinity mask for multiqueue devices
 *
 * Allocate IRQ numbers and initialized all data structures to support
 * hierarchy IRQ domains.
 * Parameter @realloc is mainly to support legacy IRQs.
 * Returns error code or allocated IRQ number
 *
 * The whole process to setup an IRQ has been split into two steps.
 * The first step, __irq_domain_alloc_irqs(), is to allocate IRQ
 * descriptor and required hardware resources. The second step,
 * irq_domain_activate_irq(), is to program the hardware with preallocated
 * resources. In this way, it's easier to rollback when failing to
 * allocate resources.
 */</span>
<span class="token keyword">int</span> <span class="token function">__irq_domain_alloc_irqs</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">irq_domain</span> <span class="token operator">*</span>domain<span class="token punctuation">,</span> <span class="token keyword">int</span> irq_base<span class="token punctuation">,</span>
                <span class="token keyword">unsigned</span> <span class="token keyword">int</span> nr_irqs<span class="token punctuation">,</span> <span class="token keyword">int</span> node<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">,</span>
                bool realloc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">irq_affinity_desc</span> <span class="token operator">*</span>affinity<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> i<span class="token punctuation">,</span> ret<span class="token punctuation">,</span> virq<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>domain <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        domain <span class="token operator">=</span> irq_default_domain<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">WARN</span><span class="token punctuation">(</span><span class="token operator">!</span>domain<span class="token punctuation">,</span> <span class="token string">"domain is NULL; cannot allocate IRQ\n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>realloc <span class="token operator">&amp;&amp;</span> irq_base <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        virq <span class="token operator">=</span> irq_base<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        virq <span class="token operator">=</span> <span class="token function">irq_domain_alloc_descs</span><span class="token punctuation">(</span>irq_base<span class="token punctuation">,</span> nr_irqs<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> node<span class="token punctuation">,</span>
                          affinity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>virq <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"cannot allocate IRQ(base %d, count %d)\n"</span><span class="token punctuation">,</span>
                 irq_base<span class="token punctuation">,</span> nr_irqs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> virq<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">irq_domain_alloc_irq_data</span><span class="token punctuation">(</span>domain<span class="token punctuation">,</span> virq<span class="token punctuation">,</span> nr_irqs<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"cannot allocate memory for IRQ%d\n"</span><span class="token punctuation">,</span> virq<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret <span class="token operator">=</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> out_free_desc<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token function">mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>irq_domain_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">irq_domain_alloc_irqs_hierarchy</span><span class="token punctuation">(</span>domain<span class="token punctuation">,</span> virq<span class="token punctuation">,</span> nr_irqs<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>irq_domain_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> out_free_irq_data<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nr_irqs<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        ret <span class="token operator">=</span> <span class="token function">irq_domain_trim_hierarchy</span><span class="token punctuation">(</span>virq <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>irq_domain_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> out_free_irq_data<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nr_irqs<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token function">irq_domain_insert_irq</span><span class="token punctuation">(</span>virq <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>irq_domain_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> virq<span class="token punctuation">;</span>

out_free_irq_data<span class="token operator">:</span>
    <span class="token function">irq_domain_free_irq_data</span><span class="token punctuation">(</span>virq<span class="token punctuation">,</span> nr_irqs<span class="token punctuation">)</span><span class="token punctuation">;</span>
out_free_desc<span class="token operator">:</span>
    <span class="token function">irq_free_descs</span><span class="token punctuation">(</span>virq<span class="token punctuation">,</span> nr_irqs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">int</span> <span class="token function">irq_domain_alloc_irqs</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">irq_domain</span> <span class="token operator">*</span>domain<span class="token punctuation">,</span>
            <span class="token keyword">unsigned</span> <span class="token keyword">int</span> nr_irqs<span class="token punctuation">,</span> <span class="token keyword">int</span> node<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">__irq_domain_alloc_irqs</span><span class="token punctuation">(</span>domain<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> nr_irqs<span class="token punctuation">,</span> node<span class="token punctuation">,</span> arg<span class="token punctuation">,</span> false<span class="token punctuation">,</span>
                       <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">dmar_alloc_hwirq</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">,</span> <span class="token keyword">int</span> node<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">struct</span> <span class="token class-name">irq_domain</span> <span class="token operator">*</span>domain <span class="token operator">=</span> <span class="token function">dmar_get_irq_domain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">irq_alloc_info</span> info<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>domain<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token function">init_irq_alloc_info</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>info<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    info<span class="token punctuation">.</span>type <span class="token operator">=</span> X86_IRQ_ALLOC_TYPE_DMAR<span class="token punctuation">;</span>
    info<span class="token punctuation">.</span>devid <span class="token operator">=</span> id<span class="token punctuation">;</span>
    info<span class="token punctuation">.</span>hwirq <span class="token operator">=</span> id<span class="token punctuation">;</span>
    info<span class="token punctuation">.</span>data <span class="token operator">=</span> arg<span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token function">irq_domain_alloc_irqs</span><span class="token punctuation">(</span>domain<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> node<span class="token punctuation">,</span> <span class="token operator">&amp;</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">start_kernel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">init_IRQ</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">native_init_IRQ</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token function">idt_setup_apic_and_irq_gates</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token function">idt_setup_from_table</span><span class="token punctuation">(</span>idt_table<span class="token punctuation">,</span> apic_idts<span class="token punctuation">,</span> <span class="token function">ARRAY_SIZE</span><span class="token punctuation">(</span>apic_idts<span class="token punctuation">)</span><span class="token punctuation">,</span> true<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="msi"><a href="#msi" class="headerlink" title="msi"></a>msi</h1><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">irq_domain_ops</span> msi_domain_ops <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token punctuation">.</span>alloc		<span class="token operator">=</span> msi_domain_alloc<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>free		<span class="token operator">=</span> msi_domain_free<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>activate	<span class="token operator">=</span> msi_domain_activate<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>deactivate	<span class="token operator">=</span> msi_domain_deactivate<span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">irq_domain_ops</span> x86_vector_domain_ops <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token punctuation">.</span>select		<span class="token operator">=</span> x86_vector_select<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>alloc		<span class="token operator">=</span> x86_vector_alloc_irqs<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>free		<span class="token operator">=</span> x86_vector_free_irqs<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>activate	<span class="token operator">=</span> x86_vector_activate<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>deactivate	<span class="token operator">=</span> x86_vector_deactivate<span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_GENERIC_IRQ_DEBUGFS</span></span>
    <span class="token punctuation">.</span>debug_show	<span class="token operator">=</span> x86_vector_debug_show<span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">msi_domain_ops_init</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">irq_domain</span> <span class="token operator">*</span>domain<span class="token punctuation">,</span>
                   <span class="token keyword">struct</span> <span class="token class-name">msi_domain_info</span> <span class="token operator">*</span>info<span class="token punctuation">,</span>
                   <span class="token keyword">unsigned</span> <span class="token keyword">int</span> virq<span class="token punctuation">,</span> <span class="token class-name">irq_hw_number_t</span> hwirq<span class="token punctuation">,</span>
                   <span class="token class-name">msi_alloc_info_t</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token function">irq_domain_set_hwirq_and_chip</span><span class="token punctuation">(</span>domain<span class="token punctuation">,</span> virq<span class="token punctuation">,</span> hwirq<span class="token punctuation">,</span> info<span class="token operator">-></span>chip<span class="token punctuation">,</span>
                      info<span class="token operator">-></span>chip_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>info<span class="token operator">-></span>handler <span class="token operator">&amp;&amp;</span> info<span class="token operator">-></span>handler_name<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">__irq_set_handler</span><span class="token punctuation">(</span>virq<span class="token punctuation">,</span> info<span class="token operator">-></span>handler<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> info<span class="token operator">-></span>handler_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>info<span class="token operator">-></span>handler_data<span class="token punctuation">)</span>
            <span class="token function">irq_set_handler_data</span><span class="token punctuation">(</span>virq<span class="token punctuation">,</span> info<span class="token operator">-></span>handler_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/**
 * irq_domain_set_hwirq_and_chip - Set hwirq and irqchip of @virq at @domain
 * @domain:	Interrupt domain to match
 * @virq:	IRQ number
 * @hwirq:	The hwirq number
 * @chip:	The associated interrupt chip
 * @chip_data:	The associated chip data
 */</span>
<span class="token keyword">int</span> <span class="token function">irq_domain_set_hwirq_and_chip</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">irq_domain</span> <span class="token operator">*</span>domain<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> virq<span class="token punctuation">,</span>
                  <span class="token class-name">irq_hw_number_t</span> hwirq<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">irq_chip</span> <span class="token operator">*</span>chip<span class="token punctuation">,</span>
                  <span class="token keyword">void</span> <span class="token operator">*</span>chip_data<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">struct</span> <span class="token class-name">irq_data</span> <span class="token operator">*</span>irq_data <span class="token operator">=</span> <span class="token function">irq_domain_get_irq_data</span><span class="token punctuation">(</span>domain<span class="token punctuation">,</span> virq<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>irq_data<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>ENOENT<span class="token punctuation">;</span>

    irq_data<span class="token operator">-></span>hwirq <span class="token operator">=</span> hwirq<span class="token punctuation">;</span>
    irq_data<span class="token operator">-></span>chip <span class="token operator">=</span> chip <span class="token operator">?</span> chip <span class="token operator">:</span> <span class="token operator">&amp;</span>no_irq_chip<span class="token punctuation">;</span>
    irq_data<span class="token operator">-></span>chip_data <span class="token operator">=</span> chip_data<span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">EXPORT_SYMBOL_GPL</span><span class="token punctuation">(</span>irq_domain_set_hwirq_and_chip<span class="token punctuation">)</span><span class="token punctuation">;</span>


ops<span class="token operator">-></span>msi_init <span class="token operator">=</span> msi_domain_ops_default<span class="token punctuation">.</span>msi_init<span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">msi_domain_alloc</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">irq_domain</span> <span class="token operator">*</span>domain<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> virq<span class="token punctuation">,</span>
                <span class="token keyword">unsigned</span> <span class="token keyword">int</span> nr_irqs<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">struct</span> <span class="token class-name">msi_domain_info</span> <span class="token operator">*</span>info <span class="token operator">=</span> domain<span class="token operator">-></span>host_data<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">msi_domain_ops</span> <span class="token operator">*</span>ops <span class="token operator">=</span> info<span class="token operator">-></span>ops<span class="token punctuation">;</span>
    <span class="token class-name">irq_hw_number_t</span> hwirq <span class="token operator">=</span> ops<span class="token operator">-></span><span class="token function">get_hwirq</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> i<span class="token punctuation">,</span> ret<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">irq_find_mapping</span><span class="token punctuation">(</span>domain<span class="token punctuation">,</span> hwirq<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EEXIST<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>domain<span class="token operator">-></span>parent<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        ret <span class="token operator">=</span> <span class="token function">irq_domain_alloc_irqs_parent</span><span class="token punctuation">(</span>domain<span class="token punctuation">,</span> virq<span class="token punctuation">,</span> nr_irqs<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nr_irqs<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        ret <span class="token operator">=</span> ops<span class="token operator">-></span><span class="token function">msi_init</span><span class="token punctuation">(</span>domain<span class="token punctuation">,</span> info<span class="token punctuation">,</span> virq <span class="token operator">+</span> i<span class="token punctuation">,</span> hwirq <span class="token operator">+</span> i<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ops<span class="token operator">-></span>msi_free<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">;</span> i <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span>
                    ops<span class="token operator">-></span><span class="token function">msi_free</span><span class="token punctuation">(</span>domain<span class="token punctuation">,</span> info<span class="token punctuation">,</span> virq <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token function">irq_domain_free_irqs_top</span><span class="token punctuation">(</span>domain<span class="token punctuation">,</span> virq<span class="token punctuation">,</span> nr_irqs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">dmar_set_interrupt</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">intel_iommu</span> <span class="token operator">*</span>iommu<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> irq<span class="token punctuation">,</span> ret<span class="token punctuation">;</span>

    <span class="token comment">/*
     * Check if the fault interrupt is already initialized.
     */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>iommu<span class="token operator">-></span>irq<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

    irq <span class="token operator">=</span> <span class="token function">dmar_alloc_hwirq</span><span class="token punctuation">(</span>iommu<span class="token operator">-></span>seq_id<span class="token punctuation">,</span> iommu<span class="token operator">-></span>node<span class="token punctuation">,</span> iommu<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>irq <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        iommu<span class="token operator">-></span>irq <span class="token operator">=</span> irq<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token function">pr_err</span><span class="token punctuation">(</span><span class="token string">"No free IRQ vectors\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    ret <span class="token operator">=</span> <span class="token function">request_irq</span><span class="token punctuation">(</span>irq<span class="token punctuation">,</span> dmar_fault<span class="token punctuation">,</span> IRQF_NO_THREAD<span class="token punctuation">,</span> iommu<span class="token operator">-></span>name<span class="token punctuation">,</span> iommu<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
        <span class="token function">pr_err</span><span class="token punctuation">(</span><span class="token string">"Can't request irq\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</div>

<!-- post-guide -->

    <div class="post-guide">
        <div class="item left">
            
              <a href="/2024/12/03/linux/%E5%86%85%E6%A0%B8-%E9%A9%B1%E5%8A%A8/%E4%B8%AD%E6%96%AD/%E8%BD%AF%E4%B8%AD%E6%96%AD--wakeup_softirqd/">
                  <i class="fa fa-angle-left" aria-hidden="true"></i>
                  软中断--wakeup_softirqd
              </a>
            
        </div>
        <div class="item right">
            
              <a href="/2024/12/03/dpdk/dpdk_legacy_memory/">
                
                <i class="fa fa-angle-right" aria-hidden="true"></i>
              </a>
            
        </div>
    </div>


<!-- comment - giscus -->


<!-- comment - valine -->


<script>
	
	
</script>
	</div>
	<div id="footer">
	<p>
	©<span id="footerYear-start"></span>-<span id="footerYear-end"></span>

	
	    <a href="/">liaocj</a>
	

	
	<br>
	Theme <a href="//github.com/sisyphus1212" target="_blank">Tree</a>
	by <a href="//space.bilibili.com/228776952" target="_blank">liaocj</a>
	Powered by <a href="//hexo.io" target="_blank">Hexo</a>
	</p>
</div>


<script type="text/javascript">
	document.getElementById('footerYear-start').innerHTML = new Date().getFullYear() + '';
</script>

<script type="text/javascript">
	document.getElementById('footerYear-end').innerHTML = new Date().getFullYear() + '';
</script>

    <script src='https://unpkg.com/mermaid@7.1.2/dist/mermaid.min.js'></script>
    <script>
      if (window.mermaid) {
        mermaid.initialize({theme: 'forest'});
      }
    </script>




<script src='https://cdnjs.cloudflare.com/ajax/libs/viz.js/1.7.1/viz.js'></script>
<script>
  String.prototype.replaceAll = function(search, replacement) {
	var target = this;
	return target.split(search).join(replacement);
  };
  let vizObjects = document.querySelectorAll('.graphviz')
  for (let item of vizObjects) {
	let svg = undefined
	try {
	  svg = Viz(item.textContent.replaceAll('–', '--'), 'svg')
	} catch(e) {
	  svg = `<pre class="error">${e}</pre>`
	}
	item.outerHTML = svg
  }
</script>

<!-- D3.js -->
<script src="https://d3js.org/d3.v6.min.js"></script>

<script>
(function(d3) {
    function initializeZoom(d3, svgElement) {
        if (!svgElement) {
            console.error('SVG element not found or passed incorrectly.');
            return;
        }

        const zoomBehavior = d3.zoom()
            .on('zoom', (event) => {
                d3.select(svgElement).select('g').attr("transform", event.transform);
            });

        d3.select(svgElement).call(zoomBehavior).on("dblclick.zoom", null);
        console.log('Zoom initialized on:', svgElement);
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Select the svg that contains #graph0 by using closest to find the parent SVG of #graph0
        const graph0 = document.querySelector('#graph0');
        if (graph0) {
            const svgElement = graph0.closest('svg'); // Find the closest svg ancestor
            if (svgElement) {
                initializeZoom(d3, svgElement);
            } else {
                console.error('No SVG element found containing #graph0');
            }
        } else {
            console.error('Element with id #graph0 not found.');
        }
    });
})(window.d3);
</script>

	<button id="totop-toggle" class="toggle"><i class="fa fa-angle-double-up" aria-hidden="true"></i></button>
</body>
</html>